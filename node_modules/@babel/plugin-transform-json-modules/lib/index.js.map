{"version":3,"names":["_helperPluginUtils","require","_pluginSyntaxImportAttributes","_helperImportToPlatformApi","_default","exports","default","declare","api","options","types","t","template","assertVersion","targets","helperESM","helperCJS","transformers","commonJS","uncheckedRequire","specifier","callExpression","webFetch","fetch","expression","ast","nodeFsSync","read","nodeFsAsync","getHelper","file","modules","get","importToPlatformApi","Error","getAttributeKey","key","isIdentifier","name","value","hasTypeJson","attributes","some","attr","inherits","syntaxImportAttributes","visitor","Program","path","node","sourceType","helper","data","decl","isImportDeclaration","assertions","phase","buildCodeFrameError","length","paths","index","id","needsNS","isImportSpecifier","local","isImportNamespaceSpecifier","scope","generateUidIdentifier","buildFetch","source","needsAwait","push","remove","buildParallelStaticImports","unshiftContainer"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport type { types as t, File } from \"@babel/core\";\nimport syntaxImportAttributes from \"@babel/plugin-syntax-import-attributes\";\nimport {\n  importToPlatformApi,\n  buildParallelStaticImports,\n  type Pieces,\n  type Builders,\n} from \"@babel/helper-import-to-platform-api\";\n\nexport interface Options {\n  uncheckedRequire: boolean;\n}\n\nexport default declare((api, options: Options) => {\n  const { types: t, template } = api;\n  api.assertVersion(REQUIRED_VERSION(\"^7.22.0\"));\n\n  const targets = api.targets();\n\n  let helperESM: Builders;\n  let helperCJS: Builders;\n\n  const transformers: Pieces = {\n    commonJS: options.uncheckedRequire\n      ? (require: t.Expression, specifier: t.Expression) =>\n          t.callExpression(require, [specifier])\n      : null,\n    webFetch: (fetch: t.Expression) =>\n      template.expression.ast`${fetch}.then(r => r.json())`,\n    nodeFsSync: (read: t.Expression) =>\n      template.expression.ast`JSON.parse(${read})`,\n    nodeFsAsync: () => template.expression.ast`JSON.parse`,\n  };\n\n  const getHelper = (file: File) => {\n    const modules = file.get(\"@babel/plugin-transform-modules-*\");\n    if (modules === \"commonjs\") {\n      return (helperCJS ??= importToPlatformApi(targets, transformers, true));\n    }\n    if (modules == null) {\n      return (helperESM ??= importToPlatformApi(targets, transformers, false));\n    }\n    throw new Error(\n      `@babel/plugin-transform-json-modules can only be used when not ` +\n        `compiling modules, or when compiling them to CommonJS.`,\n    );\n  };\n\n  function getAttributeKey({ key }: t.ImportAttribute): string {\n    return t.isIdentifier(key) ? key.name : key.value;\n  }\n\n  function hasTypeJson(attributes: t.ImportAttribute[]) {\n    return !!attributes?.some(\n      attr => getAttributeKey(attr) === \"type\" && attr.value.value === \"json\",\n    );\n  }\n\n  return {\n    name: \"transform-json-modules\",\n\n    inherits: syntaxImportAttributes,\n\n    visitor: {\n      Program(path) {\n        if (path.node.sourceType !== \"module\") return;\n\n        const helper = getHelper(this.file);\n\n        const data = [];\n        for (const decl of path.get(\"body\")) {\n          if (!decl.isImportDeclaration()) continue;\n          const attributes = decl.node.attributes || decl.node.assertions;\n          if (!hasTypeJson(attributes)) continue;\n\n          if (decl.node.phase != null) {\n            throw decl.buildCodeFrameError(\n              \"JSON modules do not support phase modifiers.\",\n            );\n          }\n          if (attributes.length > 1) {\n            const paths = decl.node.attributes\n              ? decl.get(\"attributes\")\n              : decl.get(\"assertions\");\n            const index = getAttributeKey(attributes[0]) === \"type\" ? 1 : 0;\n            throw paths[index].buildCodeFrameError(\n              \"Unknown attribute for JSON modules.\",\n            );\n          }\n\n          let id: t.Identifier;\n          let needsNS = false;\n          for (const specifier of decl.get(\"specifiers\")) {\n            if (specifier.isImportSpecifier()) {\n              throw specifier.buildCodeFrameError(\n                \"JSON modules do not support named imports.\",\n              );\n            }\n\n            id = specifier.node.local;\n            needsNS = specifier.isImportNamespaceSpecifier();\n          }\n          id ??= path.scope.generateUidIdentifier(\"_\");\n\n          let fetch = helper.buildFetch(decl.node.source, path);\n\n          if (needsNS) {\n            if (helper.needsAwait) {\n              fetch = template.expression.ast`\n                ${fetch}.then(j => ({ default: j }))\n              `;\n            } else {\n              fetch = template.expression.ast`{ default: ${fetch} }`;\n            }\n          }\n\n          data.push({ id, fetch });\n          decl.remove();\n        }\n        if (data.length === 0) return;\n\n        const decl = buildParallelStaticImports(data, helper.needsAwait);\n        if (decl) path.unshiftContainer(\"body\", decl);\n      },\n    },\n  };\n});\n"],"mappings":"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","ignoreList":[]}